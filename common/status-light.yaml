light:
  - platform: fastled_clockless
    chipset: WS2812
    pin: 27
    num_leds: 1
    rgb_order: grb
    id: status_light
    name: "Status Light"

button:
  - platform: template
    id: show_status
    name: "Show Status"
    icon: mdi:lightbulb-on
    internal: true
    on_press:
      - script.execute: update_plant_light
      - light.toggle: status_light
      - delay: 1s
      - light.toggle: status_light

script:
  - id: update_plant_light
    mode: restart
    then:
      - lambda: |-
          // Meetwaarde
          float m = id(soil_moisture).state;
          if (isnan(m)) return;

          // Drempels
          float dry = id(dry_level).state;
          float wet = id(wet_level).state;
          if (isnan(dry) || isnan(wet) || dry >= wet) return;

          // HSV-hues
          const float H_AMBER = 30.0f;
          const float H_GREEN = 120.0f;
          const float H_BLUE  = 220.0f;

          float hue;
          if (m <= dry) {
            hue = H_AMBER;
          } else if (m >= wet) {
            hue = H_BLUE;
          } else {
            float mid = (dry + wet) / 2.0f;
            if (m <= mid) {
              float t = (m - dry) / (mid - dry + 1e-6f);
              hue = H_AMBER + t * (H_GREEN - H_AMBER);
            } else {
              float t = (m - mid) / (wet - mid + 1e-6f);
              hue = H_GREEN + t * (H_BLUE - H_GREEN);
            }
          }

          // HSV â†’ RGB conversie (S=1, V=1)
          while (hue < 0) hue += 360.0f;
          while (hue >= 360.0f) hue -= 360.0f;
          float h = hue / 60.0f;
          int i = (int) floorf(h);
          float f = h - i;
          float r1, g1, b1;
          switch (i) {
            case 0: r1 = 1;   g1 = f;   b1 = 0;   break;
            case 1: r1 = 1-f; g1 = 1;   b1 = 0;   break;
            case 2: r1 = 0;   g1 = 1;   b1 = f;   break;
            case 3: r1 = 0;   g1 = 1-f; b1 = 1;   break;
            case 4: r1 = f;   g1 = 0;   b1 = 1;   break;
            default:r1 = 1;   g1 = 0;   b1 = 1-f; break;
          }

          // Stel de kleur in (zonder aanzetten)
          auto call = id(status_light).make_call();
          call.set_rgb(r1, g1, b1);
          call.perform();