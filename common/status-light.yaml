light:
  - platform: fastled_clockless
    chipset: WS2812
    pin: 27
    num_leds: 1
    rgb_order: grb
    id: status_light
    name: "Status Light"

button:
  - platform: template
    id: show_status
    name: "Show Status"
    icon: mdi:lightbulb-on
    internal: true
    on_press:
        - script.execute:
          id: update_plant_light
          moisture: !lambda 'return id(soil_moisture).state;'
      - light.toggle: status_light
      - delay: 1s
      - light.toggle: status_light

script:
  - id: update_plant_light
    mode: restart
    parameters:
      moisture: float
    then:
      - lambda: |-
          static float last_moisture = NAN;
          static float last_hue = NAN;
          float m = moisture;
          if (isnan(m)) return;

          // Drempels
          float dry = id(dry_level).state;
          float wet = id(wet_level).state;
          if (isnan(dry) || isnan(wet) || dry >= wet) return;

          // HSV-hues
          const float H_RED     = 0.0f;
          const float H_AMBER   = 30.0f;
          const float H_GREEN   = 120.0f;
          const float H_BLUE    = 220.0f;
          const float H_DEEPBLUE= 260.0f;

          // Color bands based on dry/wet config:
          float margin = 10.0f;
          float very_dry = dry - margin;
          float very_wet = wet + margin;

          float hue;
          if (m < very_dry) {
            hue = H_RED;
          } else if (m < dry) {
            float t = (m - very_dry) / (dry - very_dry + 1e-6f);
            t = fmaxf(0.0f, fminf(1.0f, t));
            hue = H_RED + t * (H_AMBER - H_RED);
          } else if (m <= wet) {
            hue = H_GREEN;
          } else if (m <= very_wet) {
            float t = (m - wet) / (very_wet - wet + 1e-6f);
            t = fmaxf(0.0f, fminf(1.0f, t));
            hue = H_GREEN + t * (H_BLUE - H_GREEN);
          } else {
            hue = H_DEEPBLUE;
          }

          // Only update if moisture or hue changed
          if (!isnan(last_moisture) && fabsf(m - last_moisture) < 0.01f && !isnan(last_hue) && fabsf(hue - last_hue) < 0.5f) {
            return;
          }
          last_moisture = m;
          last_hue = hue;
          id(set_status_light_hue).execute(hue);

  - id: set_status_light_hue
    mode: restart
    parameters:
      hue: float
    then:
      - lambda: |-
          float h = hue;
          while (h < 0) h += 360.0f;
          while (h >= 360.0f) h -= 360.0f;
          h /= 60.0f;
          int i = (int) floorf(h);
          float f = h - i;
          float r1, g1, b1;
          switch (i) {
            case 0: r1 = 1;   g1 = f;   b1 = 0;   break;
            case 1: r1 = 1-f; g1 = 1;   b1 = 0;   break;
            case 2: r1 = 0;   g1 = 1;   b1 = f;   break;
            case 3: r1 = 0;   g1 = 1-f; b1 = 1;   break;
            case 4: r1 = f;   g1 = 0;   b1 = 1;   break;
            default:r1 = 1;   g1 = 0;   b1 = 1-f; break;
          }
          auto call = id(status_light).make_call();
          call.set_rgb(r1, g1, b1);
          call.perform();